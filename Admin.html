<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Control - English Articles Game</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="container">
    <h1>👩‍🏫 Admin Control</h1>
    <p>Select a question and duration:</p>
    <select id="question-select"></select>
    <input type="number" id="duration" placeholder="Seconds" value="30" min="5" style="width:80px;" />
    <button id="emit-btn">Start Round</button>
    <p id="status"></p>

    <h3>Live Leaderboard</h3>
    <ul id="admin-leaderboard"><li>Waiting for results...</li></ul>

    <button id="reset-btn">Reset / Next Round</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase.js"></script>
    <script>
    let texts = [];

    async function loadTexts() {
        const res = await fetch("data/texts.json");
        texts = await res.json();
        const select = document.getElementById("question-select");
        texts.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.id}. ${t.title}`;
        select.appendChild(opt);
        });
    }

    // Start a new round
    document.getElementById("emit-btn").addEventListener("click", () => {
    const textId = parseInt(document.getElementById("question-select").value);
    const duration = parseInt(document.getElementById("duration").value) || 30;
    const roundId = Date.now();
    const startTime = Date.now(); // mark the moment round starts

    db.ref("currentRound").set({
        id: roundId,
        textId,
        duration,
        startTime
    });

    document.getElementById("status").textContent =
        `✅ Round ${roundId} started (${texts.find(t => t.id === textId).title}) for ${duration} seconds`;
    });

    // Reset round
    document.getElementById("reset-btn").addEventListener("click", () => {
        db.ref("currentRound").remove();
        document.getElementById("status").textContent = "🕒 Waiting for next round...";
    });

    // Live leaderboard
    let adminResults = [];
    const ref = db.ref("results").orderByChild("roundId").equalTo(String(id));
    adminResults = [];

    ref.on("child_added", (childSnap) => {
    adminResults.push(childSnap.val());
    updateAdminLeaderboard();
    });

    ref.on("child_removed", (childSnap) => {
    adminResults = adminResults.filter(r => r.roundId !== String(id));
    updateAdminLeaderboard();
    });

    function updateAdminLeaderboard() {
    if (!adminResults.length) {
        document.getElementById("admin-leaderboard").innerHTML = "<li>No results yet.</li>";
        return;
    }

    adminResults.sort((a, b) => {
        if (b.score === a.score) {
        return new Date(`${b.date} ${b.time}`) - new Date(`${a.date} ${a.time}`);
        }
        return b.score - a.score;
    });

    document.getElementById("admin-leaderboard").innerHTML = adminResults
        .map(
        (r, i) =>
            `<li>${i + 1}. ${r.username}: ${r.score}/${total} (${(
            (r.score / total) * 100
            ).toFixed(0)}%) — ${r.date} ${r.time}</li>`
        )
        .join("");
    }


    loadTexts();
    </script>

</body>
</html>
