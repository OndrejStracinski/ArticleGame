<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Control - English Articles Game</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="container">
    <h1>üë©‚Äçüè´ Admin Control</h1>
    <p>Select a question and duration:</p>
    <select id="question-select"></select>
    <input type="number" id="duration" placeholder="Seconds" value="30" min="5" style="width:80px;" />
    <button id="emit-btn">Start Round</button>
    <p id="status"></p>
    <p id="admin-timer" style="font-weight:bold; color:#c33;"></p>

    <h3>Live Leaderboard</h3>
    <ul id="admin-leaderboard"><li>Waiting for results...</li></ul>

    <button id="reset-btn">Reset / Next Round</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebase.js"></script>
    <script>
    let texts = [];

    async function loadTexts() {
    const res = await fetch("data/texts.json");
    texts = await res.json();

    const select = document.getElementById("question-select");
    select.innerHTML = ""; // clear any old options

    texts.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.id}. ${t.title}`;
        select.appendChild(opt);
    });
    }

    // Start a new round
    document.getElementById("emit-btn").addEventListener("click", () => {
    const textId = parseInt(document.getElementById("question-select").value);
    const duration = parseInt(document.getElementById("duration").value) || 30;
    const roundId = Date.now();
    const startTime = Date.now();

    db.ref("currentRound").set({
        id: roundId,
        textId,
        duration,
        startTime
    });

    document.getElementById("status").textContent =
        `‚úÖ Round ${roundId} started (${texts.find(t => t.id === textId).title}) for ${duration} seconds`;
    });

    // Reset round
    document.getElementById("reset-btn").addEventListener("click", () => {
    db.ref("currentRound").remove();
    document.getElementById("status").textContent = "üïí Waiting for next round...";
    document.getElementById("admin-leaderboard").innerHTML = "<li>No active round.</li>";
    });

    // =============================
    // ‚úÖ Live Leaderboard
    // =============================

    db.ref("currentRound").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data || !data.id || !data.textId) {
        document.getElementById("admin-leaderboard").innerHTML = "<li>No active round.</li>";
        return;
    }

    const { id, textId } = data;
    const total = texts.find(t => t.id === textId)?.answers.length || 1;

    let adminResults = [];
    const ref = db.ref("results").orderByChild("roundId").equalTo(String(id));

    ref.on("child_added", (childSnap) => {
        adminResults.push(childSnap.val());
        updateAdminLeaderboard(adminResults, total);
    });

    ref.on("child_removed", (childSnap) => {
        adminResults = adminResults.filter(r => r.roundId !== String(id));
        updateAdminLeaderboard(adminResults, total);
    });
    });

    function updateAdminLeaderboard(results, total) {
    if (!results.length) {
        document.getElementById("admin-leaderboard").innerHTML = "<li>No results yet.</li>";
        return;
    }

    results.sort((a, b) => {
        if (b.score === a.score) {
        return new Date(`${b.date} ${b.time}`) - new Date(`${a.date} ${a.time}`);
        }
        return b.score - a.score;
    });

    document.getElementById("admin-leaderboard").innerHTML = results
        .map(
        (r, i) =>
            `<li>${i + 1}. ${r.username}: ${r.score}/${total} (${(
            (r.score / total) * 100
            ).toFixed(0)}%) ‚Äî ${r.date} ${r.time}</li>`
        )
        .join("");
    }

    // Load texts after defining everything
    loadTexts();

    let adminTimerInterval = null;

    function showAdminTimer(startTime, durationSec) {
    clearInterval(adminTimerInterval);
    const el = document.getElementById("admin-timer");
    const endTime = startTime + durationSec * 1000;

    function update() {
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

        if (remaining <= 0) {
        el.textContent = "‚è≥ Round finished";
        clearInterval(adminTimerInterval);
        } else {
        el.textContent = `‚è∞ Time left: ${remaining}s`;
        }
    }

    update();
    adminTimerInterval = setInterval(update, 1000);
    }

    // Hook this into your currentRound listener:
    db.ref("currentRound").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data || !data.id || !data.textId) {
        clearInterval(adminTimerInterval);
        document.getElementById("admin-timer").textContent = "";
        document.getElementById("admin-leaderboard").innerHTML =
        "<li>No active round.</li>";
        return;
    }

    // existing leaderboard logic...
    showAdminTimer(data.startTime, data.duration);
    });



    </script>


</body>
</html>
